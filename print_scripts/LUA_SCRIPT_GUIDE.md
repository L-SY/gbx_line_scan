# LUA脚本启用说明

## 什么是LUA脚本？

LUA脚本是设备上运行的程序，用于**解析和处理**从PC发送过来的数据。不同的数据格式需要对应的LUA脚本来解析。

## 为什么需要启用脚本？

设备接收到TCP数据后，需要LUA脚本来：
1. **解析数据格式** - 识别数据是哪种格式（简易格式、JSON格式等）
2. **提取寄存器信息** - 从数据中提取寄存器号和内容
3. **存储到寄存器** - 将数据存储到对应的寄存器中
4. **更新显示对象** - 如果画布对象绑定了寄存器，会自动更新显示内容

## 脚本与数据格式的对应关系

根据文档，不同的数据格式需要使用不同的LUA脚本：

| 数据格式 | 脚本名称 | 说明 |
|---------|---------|------|
| **简易格式** | `getString_reg.lua` | 格式: `xxx [Rn]xxx\r\n` |
| **JSON格式（单寄存器）** | `getString_json.lua` | 格式: `{regNum=n,content=xxx}\r\n` |
| **JSON格式（多寄存器）** | `getString_multi_json.lua` | 格式: `{regNum=n,content=xxx}{regNum=n,content=xxx}...\r\n` |
| **特殊符号兼容格式** | `getOpMsg.lua` | 格式: `01内容1 \| 11内容2 \| 12内容3\r\n` |
| **连通性测试** | `checkConnectivity.lua` | 用于测试连接，数据存入寄存器1 |

## 如何在设备上启用脚本？

### 步骤1: 进入硬件设置界面

在设备的系统设置中，选择 **"硬件设置"** 或 **"硬件配置"**

### 步骤2: 选择通信方式

在硬件配置界面中：
- 选择 **"网络"** 通信方式（而不是"串口"）
- 配置网络参数（IP地址、端口号等）

### 步骤3: 选择并启用脚本

在硬件配置界面中，找到 **"当前脚本"** 选项：

1. **查看可用脚本列表**
   - 设备会显示已安装的脚本列表
   - 脚本可能存储在"内部"（设备内置）或"U盘"（外部安装）

2. **选择脚本**
   - 点击 **"切换"** 按钮
   - 从列表中选择你需要的脚本（如 `getString_json.lua`）

3. **启用脚本**
   - 点击 **"启用"** 或 **"加载"** 按钮
   - 确保脚本状态为"启用"（而不是"停用"）

### 步骤4: 配置寄存器号

在硬件配置中，找到 **"串口数据存入寄存器"** 选项：
- 设置数据默认存入的寄存器号（通常为9，但根据脚本不同可能不同）
- 这个设置影响数据存储的位置

## 使用示例

### 示例1: 使用JSON格式通信

**设备端配置：**
1. 通信方式：选择"网络"
2. 端口号：8989
3. 当前脚本：选择并启用 `getString_json.lua`

**PC端代码：**
```python
from embedded_board_tcp_client import EmbeddedBoardTCPClient

client = EmbeddedBoardTCPClient(host="192.168.1.100", port=8989)
client.connect()
# 发送JSON格式数据（需要设备启用 getString_json.lua）
client.send_json_format(1, "Hello")
client.disconnect()
```

### 示例2: 使用多寄存器JSON格式

**设备端配置：**
1. 当前脚本：选择并启用 `getString_multi_json.lua`

**PC端代码：**
```python
# 发送多寄存器数据（需要设备启用 getString_multi_json.lua）
client.send_json_multi_format([
    (1, "Data1"),
    (2, "Data2"),
    (3, "Data3")
])
```

### 示例3: 连通性测试

**设备端配置：**
1. 当前脚本：选择并启用 `checkConnectivity.lua`

**PC端代码：**
```python
# 发送测试数据（需要设备启用 checkConnectivity.lua）
client.send("test_connectivity\r\n")
```

## 常见问题

### Q1: 脚本在哪里？

脚本可能位于：
- **设备内部** - 设备出厂时预装的脚本
- **U盘** - 如果需要新脚本，可以下载到U盘后安装

### Q2: 如何安装新脚本？

1. 将LUA脚本文件（如 `getString_json.lua`）复制到U盘
2. 将U盘插入设备
3. 在硬件配置界面中，点击 **"刷新"** 查看U盘中的脚本
4. 选择脚本后点击 **"安装"** 或 **"加载"**

### Q3: 如何知道应该用哪个脚本？

根据你要发送的数据格式选择：
- 如果发送 `{regNum=1,content="test"}\r\n` → 使用 `getString_json.lua`
- 如果发送 `test [R1]test\r\n` → 使用 `getString_reg.lua`
- 如果发送 `01内容1 | 11内容2\r\n` → 使用 `getOpMsg.lua`

### Q4: 脚本启用后没有反应？

检查以下几点：
1. ✅ 脚本是否真的已启用（状态显示为"启用"）
2. ✅ 数据格式是否与脚本匹配
3. ✅ 数据是否以 `\r\n` 结尾
4. ✅ 寄存器号是否在有效范围内（1-16）
5. ✅ 网络连接是否正常

### Q5: 可以同时启用多个脚本吗？

**不可以**。设备一次只能启用一个脚本。如果需要切换数据格式，需要在设备上切换脚本。

## 重要提示

⚠️ **脚本必须与数据格式匹配！**

- 如果设备启用的是 `getString_json.lua`，但PC发送的是简易格式数据，设备将无法正确解析
- 如果设备启用的是 `getString_reg.lua`，但PC发送的是JSON格式数据，设备也无法正确解析

**建议：**
- 确定一种主要使用的数据格式
- 在设备上启用对应的脚本
- PC端代码使用匹配的发送方法

## 脚本切换流程

```
设备硬件设置界面
    ↓
硬件配置
    ↓
当前脚本: [显示当前脚本名称]
    ↓
点击"切换"按钮
    ↓
选择脚本列表中的脚本（如 getString_json.lua）
    ↓
点击"启用"或"加载"
    ↓
确认脚本状态为"启用"
    ↓
完成！现在可以接收对应格式的数据了
```


